name: Package and Publish 'Main' to GitHub as a Release Candidate

on:
 pull_request:
  branches: ['main']

env:
 SourceDirectory: '${{ github.workspace }}/source'
    
jobs:
 build:
  strategy:
   matrix:
    project: [
     'BenBurgers.FormalLanguagesAutomata',
     'BenBurgers.FormalLanguagesAutomata.Automata',
     'BenBurgers.FormalLanguagesAutomata.Grammars'
    ]
  runs-on: ubuntu-latest
  permissions:
   contents: read
   packages: write

  steps:
   - name: Checkout repository
     uses: actions/checkout@v3
   - name: Setup .NET SDK 7.0.x
     uses: actions/setup-dotnet@v3
     with:
      dotnet-version: 7.0.x
   - name: Cache dependencies
     uses: actions/cache@v3
     with:
      path: ~/.nuget/packages
      key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
      restore-keys: |
       ${{ runner.os }}-nuget
   - name: Install dependencies
     working-directory: ${{ env.SourceDirectory }}
     run: dotnet restore
   - name: Build
     working-directory: ${{ env.SourceDirectory }}
     run: dotnet build --configuration Debug --no-restore
   - name: Test
     working-directory: ${{ env.SourceDirectory }}
     run: dotnet test --configuration Debug --no-restore --no-build --verbosity normal
   - name: Create the package 'BenBurgers.FormalLanguagesAutomata'
     working-directory: ${{ env.SourceDirectory }}/${{ matrix.project }}
     run: dotnet pack --configuration Debug -p:PackageVersion=0.5.${{ github.run_number }}-rc
   - name: Publish the package to GitHub Packages Registry
     working-directory: ${{ env.SourceDirectory }}/${{ matrix.project }}
     run: dotnet nuget push ${{ env.SourceDirectory }}/${{ matrix.project }}/bin/Release/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source "GitHub BenBurgers" --skip-duplicate